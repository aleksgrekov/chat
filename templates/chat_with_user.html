<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Чат с {% if messages and messages|length > 0 %}{{ messages[1].user.first_name or messages[1].user.username }}{% else %}Пользователем{% endif %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #eef1f5; /* Нейтральный фон */
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px; /* Уменьшено до 15px */
        }
        .chat-container {
            background-color: #fff;
            border-radius: 8px;
            padding: 10px; /* Уменьшено до 10px */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .message {
            padding: 6px; /* Уменьшено до 6px */
            border-radius: 4px;
            margin-bottom: 5px; /* Уменьшено до 5px */
            display: flex;
            flex-direction: column;
            max-width: 70%;
        }
        .message-sender {
            font-weight: bold;
            color: #333;
            margin-bottom: 2px;
        }
        .message-time {
            font-size: 0.7rem; /* Уменьшено до 0.7rem */
            color: #aaa;
            margin-bottom: 3px; /* Уменьшено до 3px */
            align-self: flex-end;
        }
        .message-text {
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #333;
        }
        .message.user-message {
            background-color: #e1f5fe; /* Нежный синий для сообщений пользователя */
            border: 1px solid #b3e5fc; /* Легкая граница */
        }
        .message.other-message {
            background-color: #f9f9f9; /* Светло-серый для сообщений других пользователей */
            border: 1px solid #e0e0e0; /* Легкая граница */
        }
        .form-group {
            margin-top: 15px; /* Уменьшено до 15px */
        }
        textarea {
            resize: none; /* Отключаем возможность изменения размера */
            height: 40px; /* Задаем фиксированную высоту */
            margin-bottom: 5px; /* Уменьшено до 5px */
        }
    </style>
</head>
<body>

<div class="container">
    <div class="chat-container">
        <h3 class="text-center">Чат с {% if messages and messages|length > 0 %}{{ messages[1].user.first_name or messages[1].user.username }}{% else %}Пользователем{% endif %}</h3>

        <div class="messages-list" id='messages'>
            {% if messages and messages|length > 0 %}
            {% for message in messages %}
            <div class="message {% if message.user.username == username %}user-message{% else %}other-message{% endif %}">
                <div class="message-sender">
                    {{ message.user.first_name or message.user.username }}
                </div>
                <div class="message-time">
                    {{ message.datetime.strftime('%d %b %Y %H:%M') }}
                </div>
                <div class="message-text">
                    {{ message.message }}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-center">Пока нет сообщений</p>
            {% endif %}
        </div>

        <div class="form-group">
            <textarea class="form-control" id="messageInput" placeholder="Введите ваше сообщение..."
                      maxlength="200"></textarea>
            <button class="btn btn-primary" id="sendMessage">Отправить сообщение</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Подключаемся к WebSocket серверу
    const socket = new WebSocket('ws://localhost:8000/mychat/ws/chat');

    socket.onopen = function() {
        console.log('Соединение с WebSocket установлено');
    };

    socket.onmessage = function(event) {
        const data = JSON.parse(event.data); // Предполагается, что данные приходят в формате JSON
        const messages = document.getElementById('messages');
        const message = document.createElement('div');

        // Добавляем соответствующий класс в зависимости от отправителя
        message.className = `message ${data.user === '{{ username }}' ? 'user-message' : 'other-message'}`;

        // Создаем элементы для отображения информации о сообщении
        const sender = document.createElement('div');
        sender.className = 'message-sender';
        sender.textContent = data.user;

        const date = new Date(data.datetime);
        const time = document.createElement('div');
        time.className = 'message-time';
        time.textContent = `${date.getDate().toString().padStart(2, '0')} ${date.toLocaleString('en-EN', { month: 'short' })} ${date.getFullYear()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;

        const messageText = document.createElement('div');
        messageText.className = 'message-text';
        messageText.textContent = data.message;

        // Добавляем все элементы в одно сообщение
        message.appendChild(sender);
        message.appendChild(time);
        message.appendChild(messageText);

        // Добавляем новое сообщение в список сообщений
        messages.appendChild(message);
    };

    document.getElementById('sendMessage').addEventListener('click', function() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value;

        if (message.trim() !== '') {
            // Отправка сообщения через WebSocket
            socket.send(JSON.stringify({
                'message': message,
                'user': '{{ username }}',
                'chat': {{ chat_id }},
                'datetime': new Date().toISOString()
            }));
            messageInput.value = '';  // Очистить поле ввода после отправки
        }
    });
</script>
</body>
</html>